// ==UserScript==
// @name         Stack User Profiles
// @description  Make use of the space like before.
// @version      2.5
//
// @namespace    scratte-fiddlings
// @author       Scratte (https://stackoverflow.com/users/12695027)
//
// @include      /^https://(?:meta\.)?askubuntu\.com/users//
// @include      /^https://(?:meta\.)?mathoverflow\.net/users//
// @include      /^https://(?:[^/]+\.)?stackoverflow\.com/users//
// @include      /^https://(?:meta\.)?superuser\.com/users//
// @include      /^https://(?:meta\.)?serverfault\.com/users//
// @include      /^https://stackapps\.com/users//
// @include      /^https://[^/]+\.stackexchange\.com/users//
// @exclude      *://api.stackexchange.com/*
// @exclude      *://data.stackexchange.com/*
// @exclude      *://elections.stackexchange.com/*
// @exclude      *://openid.stackexchange.com/*
// @exclude      *://blog.*.com/*
// @exclude      *://chat.*.com/*
// @exclude      *://contests.*.com/*
//
// @grant        none
// ==/UserScript==
!function(){"use strict";const e=["Profile","Профиль","Perfil","プロフィール"],t=async()=>{const t={};t.userId=document.location.pathname.match(/\/(\d+)(?:\/|$)/)?.[1];const[n]=await(e=>{const t=document.querySelectorAll(e);return t.length?Promise.resolve(t):new Promise((t=>{const n=new MutationObserver((()=>{const a=document.querySelectorAll(e);a.length&&(n.disconnect(),t(a))}));n.observe(document,{subtree:!0,childList:!0,attributes:!0})}))})("#mainbar-full");if(!n)return;const a=n.children,s=a[0]?.classList.contains("js-cursor-container")?1:0,r=a[s+0];t.hugeUselessTopBar=r;const l=r.children,o=l[0].children,i=o[0];t.avatar=i;const c=i.cloneNode(!0);t.avatarClone=c,t.avatarCloneImage=c.querySelector("img");const d=o[1];t.userDetails=d;d.children;const m=d.firstElementChild;t.userName=m,t.headerExists=!!d.querySelector(".fs-title"),t.userLists=d.querySelectorAll("ul:not(#groups-popover > ul)"),t.userFirstList=t.userLists[0];const p=m.cloneNode(!0);t.userNameClone=p,t.userNameCloneElement=p.querySelector(".fs-headline2");const u=l[1];t.profileButtonClone=u.cloneNode(!0);const g=a[s+1];if(t.tabs=g,t.page=g.querySelector(".is-selected")?.textContent,e.includes(t.page)){const e=a[s+2].children,n=e[0];t.topMainContent=n;const r=n.children;t.stats=r[0];const l=r[1];t.airOfMysteryContainer=l.firstElementChild?.lastElementChild?.cloneNode(!0),t.profileTextArea=l,t.prose=l.children[1];const o=e[1];t.bottomMainContent=o;const i=o.children;t.contributions=i[1]}return t},n=t=>{const{airOfMysteryContainer:n,contributions:s,profileButtonClone:r,profileTextArea:l,prose:o,stats:i,userFirstList:c}=t;if(t.avatarClone.style.marginRight="10px",t.avatar.querySelectorAll(".d-none").forEach((e=>e.remove())),t.avatarCloneImage.querySelectorAll(".d-none").forEach((e=>e.remove())),t.avatarCloneImage.width=t.avatarCloneImage.height=30,t.userNameCloneElement.classList.remove("mb12","fs-headline2"),t.userNameCloneElement.style.fontSize="1.61538461rem",t.userNameClone.style.marginRight="10px","Edit profile"===r.firstElementChild?.textContent.trim()&&r.firstElementChild.remove(),r.classList.remove("ps-absolute"),t.tabs.append(t.avatarClone,t.userNameClone,r),e.includes(t.page)){if(t.topMainContent.className="d-flex mb32 md:fd-column",l.firstElementChild.replaceWith(t.userDetails),o){const{classList:e,style:n}=o;e.remove("overflow-hidden","v-truncate-fade","hmx3"),e.add("overflow-y-scroll"),n.marginRight="-5px",n.paddingRight="5px",n.maxHeight=t.headerExists?"211px":"235px";const a=o.nextElementSibling;a&&a.remove()}else t.userDetails.append(n),n.classList.remove("flex-center"),n.style.marginRight="50px";const e=document.createElement("div");e.classList.add("d-flex","fl-grow1"),l.replaceWith(e),c.style.flexDirection="column";for(let e=1;e<t.userLists.length;e++)c.append(...t.userLists[e].querySelectorAll("li:not(#groups-popover li)")),t.userLists[e].remove();[...c.children].forEach((e=>{if(e.querySelector(".v-visible-sr")?.remove(),!e.textContent.trim()){const t=e.querySelector("a"),n=t.cloneNode(!0);n.textContent=t.href.toString().replace("https://",""),e.append(n)}})),c.style.whiteSpace="nowrap";const r=document.createElement("div");r.append(c),t.rightSide=r,l.style.marginRight="20px",l.classList.add("fl-grow1"),e.append(l,r);s?.children?.length>1?(t.bottomMainContent?.classList.remove("gs24"),s.classList.add("ml24","d-flex","fd-column"),[...s.children].forEach((e=>{e.classList.remove("mb32","mb48","mt64","pt32"),e.classList.add("mb24")}))):document.querySelector(".profile-placeholder--image")?.parentNode?.classList.remove("mt64","pt32"),(e=>{let{stats:t}=e;t.classList.contains("grid--item")&&(t=t.firstElementChild,t.className="flex--item fl-shrink0 ws2 mr24 md:mr0 md:mb24 md:w100 d-flex");const n=t.children,s=n[0],r=n[1];r.style.alignSelf="center",r.style.border="none";const l=r.firstElementChild.children,o=l[0],i=l[1],c=l[2],d=l[3];c.style.marginRight="30px",i.remove();const m=r.querySelector(".js-rank-container");m&&(m.firstElementChild?.remove(),m.firstElementChild?.classList.add("d-flex"),e.userName.append(m));const p=document.createElement("div");p.className="d-flex",p.style.marginBottom="20px",p.append(c,d),e.rightSide.append(p,e.userFirstList),o.classList.remove("flex--item"),o.classList.add("d-flex"),o.firstElementChild.style.paddingRight="5px",o.firstElementChild.style.marginTop="-2px",o.parentElement?.classList.remove("flex__allcells6");const u=e.avatar.querySelector("img");u.removeAttribute("width"),u.removeAttribute("height"),u.style.width="100%",e.avatar.style.padding="10px",s.replaceWith(e.avatar),t.classList.add("d-flex"),t.style.flexDirection="column",t.append(a())})(t)}t.hugeUselessTopBar.remove()},a=()=>{const e=(e,t)=>{const n=document.createElement("span");n.classList.add("flex--item");const a=document.createElement("span");a.classList.add("d-flex","flex__center","fl1"),a.textContent=t;const s=document.createElement("div");switch(s.classList.add("d-flex","ai-center","s-badge"),e){case"gold":case"oro":case"ouro":case"золотых":case"золотой":s.classList.add("s-badge__gold"),s.title=t+" gold badges",n.classList.add("badge1");break;case"silver":case"plata":case"prata":case"серебряных":case"серебряный":s.classList.add("s-badge__silver"),s.title=t+" silver badges",n.classList.add("badge2");break;case"bronze":case"bronce":case"бронзовых":case"бронзовый":s.classList.add("s-badge__bronze"),s.title=t+" bronze badges",n.classList.add("badge3")}s.append(n,a);const r=document.createElement("div");return r.classList.add("flex--item"),r.append(s),r},t=document.createElement("div");t.classList.add("d-flex","gs4","flex__fl-equal");const n=document.querySelector("#badges");let a;return a=n?[...n.querySelectorAll(".fs-caption")].map((t=>{const n=t.textContent.trim().replace(" badges","").replace(" badge","").replace("medallas de ","").replace("medalla de ","").replace("medalhas de ","").replace(" знаков","").replace(" знака","").replace(" знак",""),a=t.previousElementSibling?.textContent.trim();if(a)return e(n,a)})):[e("bronze",0)],t.append(...a),t.style.padding="10px",t},s=e=>{let t=e.title;return t||(t=e.firstElementChild?.title,t||e.querySelector(".date_brick")?.title)},r=(e,t,n)=>{const a=document.createElement("li");return a.textContent=t,a.style.listStyleType=`"${e} "`,a.title=n,a},l=(e,t)=>{const n=document.createElement("h3");n.textContent="Activity",n.style.color="var(--theme-primary-400)",n.style.margin="0";const a=document.createElement("ul");t?a.append(r("⇑",s(e||t),"Most recent"),r("⇓",s(t),"Very first"),r(" "," "),r("⌚",(()=>{const e=(new Date).toISOString();return e.substr(0,10)+" "+e.substr(11,8)+e.substr(23)})(),"Current time")):a.append(r(" ","❌ none")),a.style.lineHeight="1.5",a.style.marginLeft="15px";const l=document.createElement("div");return l.style.marginLeft="2px",l.style.marginTop="20px",l.style.whiteSpace="nowrap",l.append(n,a),l},o=async e=>{const{location:t}=window,n=t.pathname,a=await fetch(`${n}?tab=activity&sort=all&page=${e}`),s=await a.text();return(new DOMParser).parseFromString(s,"text/html")},i=async({userId:e,userFirstList:t})=>{const n=(e,t=!1)=>{if(!e)return;const a=(new Date).getTime()/1e3-e+StackExchange.options.serverTimeOffsetSec;var s;return isNaN(a)||a<0?void 0:(!t&&a<2?"just now":!t&&a<60&&(1===(s={seconds:Math.floor(a)}).seconds?s.seconds+" sec ago":s.seconds+" secs ago"))||!t&&a<120&&"1 min ago"||!t&&a<3600&&function(e){return 1===e.minutes?e.minutes+" min ago":e.minutes+" mins ago"}({minutes:Math.floor(a/60)})||!t&&a<7200&&"1 hour ago"||!t&&a<43200&&function(e){return 1===e.hours?e.hours+" hour ago":e.hours+" hours ago"}({hours:Math.floor(a/3600)})||!t&&a<86400&&"today"||!t&&a<172800&&"yesterday"||!t&&a<604800&&function(e){return e.days+" days ago"}({days:Math.floor(a/86400)})||!t&&a<2592e3&&function(e){return 1===e.weeks?e.weeks+" week ago":e.weeks+" weeks ago"}({weeks:Math.floor(a/604800)})||a<31536e3&&function(e){return 0===e.months?"":1===e.months?e.months+" month ago":e.months+" months ago"}({months:Math.floor(a/2635200)})||!t&&function(t){const s=n(e+31536e3*Math.floor(a/31536e3),!0);return(1===t.years?t.years+" year":t.years+" years")+(s?", "+s:" ago")}({years:Math.floor(a/31536e3)})},a=(e,t)=>{const a=document.createElement("div");let s;var r;"view"===e?(a.textContent=`${r=t.view_count,r.toLocaleString("en-US")} profile views`,s=Svg?.Eye().get(0)):(a.title=(e=>{var t=new Date;return t.setTime(1e3*e),[t.getUTCFullYear(),"-",n(t.getUTCMonth()+1),"-",n(t.getUTCDate())," ",n(t.getUTCHours()),":",n(t.getUTCMinutes()),":",n(t.getUTCSeconds()),"Z"].join("");function n(e){return e<10?"0"+e:e}})(t.last_access_date),a.textContent=`Last seen ${n(t.last_access_date)}`,s=Svg?.Clock().get(0));const l=document.createElement("div");l.className="flex--item",l.append(a);const o=document.createElement("div");o.className="flex--item fc-black-350",o.append(s);const i=document.createElement("div");i.className="d-flex gs4 gsx ai-center",i.append(o,l);const c=document.createElement("li");return c.className="flex--item",c.append(i),c},s=await(async e=>{const t=window.location.hostname,n=await fetch(`https://api.stackexchange.com/2.2/users/${e}?filter=!bWWrYUhX0a2k7x&site=${t}&key=Ql5)rGNzh1JB8xiEjeYQmQ((`);return(await n.json())?.items[0]})(e);t.append(a("view",s),a("last",s))};(async()=>{const a=await t();n(a),e.includes(a.page)&&(async({elementToAppend:e,headerPresent:t,elementToAdjust:n})=>{const a=e=>new Promise((t=>setTimeout(t,1e3*e))),s=e=>{const t=e.querySelectorAll(".date");if(t)return t[t.length-1]},r=e=>{const t=e.querySelectorAll(".history-table tr");for(const e of t){const t=e.children;if(t.length>1&&"awarded"!==t[1].textContent)return t[0]}},i=(a,s)=>{e.append(l(a,s));const r=+n?.style.maxHeight.replace("px",""),o=parseInt(window.getComputedStyle(e).height);n&&(n.style.maxHeight=Math.max(r,o-92+(t?0:20))+"px")};let c,d,m,p=1;const u=await o(p++),g=u.querySelector(".s-pagination");if(!g)return d=r(u),m=s(u),void i(d,m);{let e=g.lastElementChild;e&&"Next"===e.textContent.trim()&&(e=e.previousElementSibling),c=e.textContent.trim()}for(d=r(u);!d&&p<c;){await a(1+Math.random()+.1);const e=await o(p++);d=r(e),p===c&&(m=s(e))}p!==c&&(await a(1+Math.random()+.1),m=s(await o(c)));i(d,m)})({elementToAppend:a.rightSide,headerPresent:a.headerExists,elementToAdjust:a.prose}),(()=>{const e=document.createElement("style");e.innerText="\n            .flex--item.fl1 #top-tags {\n                order: 1;\n            }\n            .flex--item.fl1 #top-posts {\n                order: 2;\n            }\n            .flex--item.fl1 #badges {\n                order: 3;\n            }\n\n            .profile-badges .fl1:nth-child(2) {\n                display: flex;\n                align-items: center;\n            }\n\n            .profile-badges .fs-title {\n                float: left;\n                margin-right: 4px;\n            }\n\n            .spotAward {\n                transform: scale(0.75,0.75);\n            }\n\n            /* make the background transparent on the tag badge medal */\n            .badge1-alternate.badge-tag,\n            .badge2-alternate.badge-tag,\n            .badge3-alternate.badge-tag {\n                background-color: transparent !important;\n            }\n\n            /* center the tag badge medal */\n            .profile-top-tags > div:first-child .badge1-alternate.badge-tag > span,\n            .profile-top-tags > div:first-child .badge2-alternate.badge-tag > span,\n            .profile-top-tags > div:first-child .badge3-alternate.badge-tag > span {\n                vertical-align: initial !important;\n            }\n            ",document.head.appendChild(e)})(),i(a)})()}();