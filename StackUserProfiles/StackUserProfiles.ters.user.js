// ==UserScript==
// @name         Stack User Profiles
// @description  Make use of the space like before.
// @version      2.4
//
// @namespace    scratte-fiddlings
// @author       Scratte (https://stackoverflow.com/users/12695027)
//
// @include      /^https://(?:meta\.)?askubuntu\.com/users//
// @include      /^https://(?:meta\.)?mathoverflow\.net/users//
// @include      /^https://(?:[^/]+\.)?stackoverflow\.com/users//
// @include      /^https://(?:meta\.)?superuser\.com/users//
// @include      /^https://(?:meta\.)?serverfault\.com/users//
// @include      /^https://stackapps\.com/users//
// @include      /^https://[^/]+\.stackexchange\.com/users//
// @exclude      *://api.stackexchange.com/*
// @exclude      *://data.stackexchange.com/*
// @exclude      *://elections.stackexchange.com/*
// @exclude      *://openid.stackexchange.com/*
// @exclude      *://blog.*.com/*
// @exclude      *://chat.*.com/*
// @exclude      *://contests.*.com/*
//
// @grant        none
// ==/UserScript==
!function(){"use strict";const e=["Profile","Профиль","Perfil","プロフィール"],t=()=>{const e=(e,t)=>{const n=document.createElement("span");n.classList.add("flex--item");const s=document.createElement("span");s.classList.add("d-flex","flex__center","fl1"),s.textContent=t;const a=document.createElement("div");switch(a.classList.add("d-flex","ai-center","s-badge"),e){case"gold":case"oro":case"ouro":case"золотых":case"золотой":a.classList.add("s-badge__gold"),a.title=t+" gold badges",n.classList.add("badge1");break;case"silver":case"plata":case"prata":case"серебряных":case"серебряный":a.classList.add("s-badge__silver"),a.title=t+" silver badges",n.classList.add("badge2");break;case"bronze":case"bronce":case"бронзовых":case"бронзовый":a.classList.add("s-badge__bronze"),a.title=t+" bronze badges",n.classList.add("badge3")}a.append(n,s);const r=document.createElement("div");return r.classList.add("flex--item"),r.append(a),r},t=document.createElement("div");t.classList.add("d-flex","gs4","flex__fl-equal");const n=document.querySelector("#badges");let s;return s=n?[...n.querySelectorAll(".fs-caption")].map((t=>{const n=t.textContent.trim().replace(" badges","").replace(" badge","").replace("medallas de ","").replace("medalla de ","").replace("medalhas de ","").replace(" знаков","").replace(" знака","").replace(" знак",""),s=t.previousElementSibling?.textContent.trim();if(s)return e(n,s)})):[e("bronze",0)],t.append(...s),t.style.padding="10px",t},n=e=>{let t=e.title;return t||(t=e.firstElementChild?.title,t||e.querySelector(".date_brick")?.title)},s=(e,t,n)=>{const s=document.createElement("li");return s.textContent=t,s.style.listStyleType=`"${e} "`,s.title=n,s},a=(e,t)=>{const a=document.createElement("h3");a.textContent="Activity",a.style.color="var(--theme-primary-400)",a.style.margin="0";const r=document.createElement("ul");t?r.append(s("⇑",n(e||t),"Most recent"),s("⇓",n(t),"Very first"),s(" "," "),s("⌚",(()=>{const e=(new Date).toISOString();return e.substr(0,10)+" "+e.substr(11,8)+e.substr(23)})(),"Current time")):r.append(s(" ","❌ none")),r.style.lineHeight="1.5",r.style.marginLeft="15px";const l=document.createElement("div");return l.style.marginLeft="2px",l.style.marginTop="20px",l.style.whiteSpace="nowrap",l.append(a,r),l},r=async e=>{const{location:t}=window,n=t.pathname,s=await fetch(`${n}?tab=activity&sort=all&page=${e}`),a=await s.text();return(new DOMParser).parseFromString(a,"text/html")},l=(()=>{const t={};t.userId=document.location.pathname.match(/\/(\d+)(?:\/|$)/)?.[1];const n=document.querySelector("#mainbar-full");if(!n)return;const s=n.children,a=s[0];t.hugeUselessTopBar=a;const r=a.children,l=r[0].children,o=l[0];t.avatar=o;const i=o.cloneNode(!0);t.avatarClone=i,t.avatarCloneImage=i.querySelector("img");const c=l[1];t.userDetails=c;c.children;const d=c.firstElementChild;t.userName=d,t.headerExists=!!c.querySelector(".fs-title"),t.userLists=c.querySelectorAll("ul:not(#groups-popover > ul)"),t.userFirstList=t.userLists[0];const m=d.cloneNode(!0);t.userNameClone=m,t.userNameCloneElement=m.querySelector(".fs-headline2");const p=r[1];t.profileButtonClone=p.cloneNode(!0);const u=s[1];if(t.tabs=u,t.page=u.querySelector(".is-selected")?.textContent,e.includes(t.page)){const e=s[2].children,n=e[0];t.topMainContent=n;const a=n.children;t.stats=a[0];const r=a[1];t.airOfMysteryContainer=r.firstElementChild?.lastElementChild?.cloneNode(!0),t.profileTextArea=r,t.prose=r.children[1];const l=e[1];t.bottomMainContent=l;const o=l.children;t.contributions=o[1]}return t})();(n=>{const{airOfMysteryContainer:s,contributions:a,profileButtonClone:r,profileTextArea:l,prose:o,stats:i,userFirstList:c}=n;if(n.avatarClone.style.marginRight="10px",n.avatar.querySelectorAll(".d-none").forEach((e=>e.remove())),n.avatarCloneImage.querySelectorAll(".d-none").forEach((e=>e.remove())),n.avatarCloneImage.width=n.avatarCloneImage.height=30,n.userNameCloneElement.classList.remove("mb12","fs-headline2"),n.userNameCloneElement.style.fontSize="1.61538461rem",n.userNameClone.style.marginRight="10px","Edit profile"===r.firstElementChild?.textContent.trim()&&r.firstElementChild.remove(),r.classList.remove("ps-absolute"),n.tabs.append(n.avatarClone,n.userNameClone,r),e.includes(n.page)){if(n.topMainContent.className="d-flex mb32 md:fd-column",l.firstElementChild.replaceWith(n.userDetails),o){const{classList:e,style:t}=o;e.remove("overflow-hidden","v-truncate-fade","hmx3"),e.add("overflow-y-scroll"),t.marginRight="-5px",t.paddingRight="5px",t.maxHeight=n.headerExists?"211px":"235px";const s=o.nextElementSibling;s&&s.remove()}else n.userDetails.append(s),s.classList.remove("flex-center"),s.style.marginRight="50px";const e=document.createElement("div");e.classList.add("d-flex","fl-grow1"),l.replaceWith(e),c.style.flexDirection="column";for(let e=1;e<n.userLists.length;e++)c.append(...n.userLists[e].querySelectorAll("li:not(#groups-popover li)")),n.userLists[e].remove();[...c.children].forEach((e=>{if(e.querySelector(".v-visible-sr")?.remove(),!e.textContent.trim()){const t=e.querySelector("a"),n=t.cloneNode(!0);n.textContent=t.href.toString().replace("https://",""),e.append(n)}})),c.style.whiteSpace="nowrap";const r=document.createElement("div");r.append(c),n.rightSide=r,l.style.marginRight="20px",l.classList.add("fl-grow1"),e.append(l,r);a?.children?.length>1?(n.bottomMainContent?.classList.remove("gs24"),a.classList.add("ml24","d-flex","fd-column"),[...a.children].forEach((e=>{e.classList.remove("mb32","mb48","mt64","pt32"),e.classList.add("mb24")}))):document.querySelector(".profile-placeholder--image")?.parentNode?.classList.remove("mt64","pt32"),(e=>{let{stats:n}=e;n.classList.contains("grid--item")&&(n=n.firstElementChild,n.className="flex--item fl-shrink0 ws2 mr24 md:mr0 md:mb24 md:w100 d-flex");const s=n.children,a=s[0],r=s[1];r.style.alignSelf="center",r.style.border="none";const l=r.firstElementChild.children,o=l[0],i=l[1],c=l[2],d=l[3];c.style.marginRight="30px",i.remove();const m=r.querySelector(".js-rank-container");m&&(m.firstElementChild?.remove(),m.firstElementChild?.classList.add("d-flex"),e.userName.append(m));const p=document.createElement("div");p.className="d-flex",p.style.marginBottom="20px",p.append(c,d),e.rightSide.append(p,e.userFirstList),o.classList.remove("flex--item"),o.classList.add("d-flex"),o.firstElementChild.style.paddingRight="5px",o.firstElementChild.style.marginTop="-2px",o.parentElement?.classList.remove("flex__allcells6");const u=e.avatar.querySelector("img");u.removeAttribute("width"),u.removeAttribute("height"),u.style.width="100%",e.avatar.style.padding="10px",a.replaceWith(e.avatar),n.classList.add("d-flex"),n.style.flexDirection="column",n.append(t())})(n)}n.hugeUselessTopBar.remove()})(l),e.includes(l.page)&&(async({elementToAppend:e,headerPresent:t,elementToAdjust:n})=>{const s=e=>new Promise((t=>setTimeout(t,1e3*e))),l=e=>{const t=e.querySelectorAll(".date");if(t)return t[t.length-1]},o=e=>{const t=e.querySelectorAll(".history-table tr");for(const e of t){const t=e.children;if(t.length>1&&"awarded"!==t[1].textContent)return t[0]}},i=(s,r)=>{e.append(a(s,r));const l=+n?.style.maxHeight.replace("px",""),o=parseInt(window.getComputedStyle(e).height);n&&(n.style.maxHeight=Math.max(l,o-92+(t?0:20))+"px")};let c,d,m,p=1;const u=await r(p++),h=u.querySelector(".s-pagination");if(!h)return d=o(u),m=l(u),void i(d,m);{let e=h.lastElementChild;e&&"Next"===e.textContent.trim()&&(e=e.previousElementSibling),c=e.textContent.trim()}for(d=o(u);!d&&p<c;){await s(1+Math.random()+.1);const e=await r(p++);d=o(e),p===c&&(m=l(e))}if(p!==c){await s(1+Math.random()+.1);m=l(await r(c))}i(d,m)})({elementToAppend:l.rightSide,headerPresent:l.headerExists,elementToAdjust:l.prose}),(()=>{const e=document.createElement("style");e.innerText="\n            .flex--item.fl1 #top-tags {\n                order: 1;\n            }\n            .flex--item.fl1 #top-posts {\n                order: 2;\n            }\n            .flex--item.fl1 #badges {\n                order: 3;\n            }\n\n            .profile-badges .fl1:nth-child(2) {\n                display: flex;\n                align-items: center;\n            }\n\n            .profile-badges .fs-title {\n                float: left;\n                margin-right: 4px;\n            }\n\n            .spotAward {\n                transform: scale(0.75,0.75);",document.head.appendChild(e)})(),(async({userId:e,userFirstList:t})=>{const n=(e,t=!1)=>{if(!e)return;const s=(new Date).getTime()/1e3-e+StackExchange.options.serverTimeOffsetSec;var a;return isNaN(s)||s<0?void 0:(!t&&s<2?"just now":!t&&s<60&&(1===(a={seconds:Math.floor(s)}).seconds?a.seconds+" sec ago":a.seconds+" secs ago"))||!t&&s<120&&"1 min ago"||!t&&s<3600&&function(e){return 1===e.minutes?e.minutes+" min ago":e.minutes+" mins ago"}({minutes:Math.floor(s/60)})||!t&&s<7200&&"1 hour ago"||!t&&s<43200&&function(e){return 1===e.hours?e.hours+" hour ago":e.hours+" hours ago"}({hours:Math.floor(s/3600)})||!t&&s<86400&&"today"||!t&&s<172800&&"yesterday"||!t&&s<604800&&function(e){return e.days+" days ago"}({days:Math.floor(s/86400)})||!t&&s<2592e3&&function(e){return 1===e.weeks?e.weeks+" week ago":e.weeks+" weeks ago"}({weeks:Math.floor(s/604800)})||s<31536e3&&function(e){return 0===e.months?"":1===e.months?e.months+" month ago":e.months+" months ago"}({months:Math.floor(s/2635200)})||!t&&function(t){const a=n(e+31536e3*Math.floor(s/31536e3),!0);return(1===t.years?t.years+" year":t.years+" years")+(a?", "+a:" ago")}({years:Math.floor(s/31536e3)})},s=(e,t)=>{const s=document.createElement("div");let a;var r;"view"===e?(s.textContent=`${r=t.view_count,r.toLocaleString("en-US")} profile views`,a=Svg?.Eye().get(0)):(s.title=(e=>{var t=new Date;return t.setTime(1e3*e),[t.getUTCFullYear(),"-",n(t.getUTCMonth()+1),"-",n(t.getUTCDate())," ",n(t.getUTCHours()),":",n(t.getUTCMinutes()),":",n(t.getUTCSeconds()),"Z"].join("");function n(e){return e<10?"0"+e:e}})(t.last_access_date),s.textContent=`Last seen ${n(t.last_access_date)}`,a=Svg?.Clock().get(0));const l=document.createElement("div");l.className="flex--item",l.append(s);const o=document.createElement("div");o.className="flex--item fc-black-350",o.append(a);const i=document.createElement("div");i.className="d-flex gs4 gsx ai-center",i.append(o,l);const c=document.createElement("li");return c.className="flex--item",c.append(i),c},a=await(async e=>{const t=window.location.hostname,n=await fetch(`https://api.stackexchange.com/2.2/users/${e}?filter=!bWWrYUhX0a2k7x&site=${t}&key=Ql5)rGNzh1JB8xiEjeYQmQ((`);return(await n.json())?.items[0]})(e);t.append(s("view",a),s("last",a))})(l)}();