// ==UserScript==
// @name         Stack User Profiles
// @description  Make use of the space like before.
// @version      3.4
//
// @namespace    scratte-fiddlings
// @author       Scratte (https://stackoverflow.com/users/12695027)
//
// @include      /^https://(?:meta\.)?askubuntu\.com/users//
// @include      /^https://(?:meta\.)?mathoverflow\.net/users//
// @include      /^https://(?:[^/]+\.)?stackoverflow\.com/users//
// @include      /^https://(?:meta\.)?superuser\.com/users//
// @include      /^https://(?:meta\.)?serverfault\.com/users//
// @include      /^https://stackapps\.com/users//
// @include      /^https://[^/]+\.stackexchange\.com/users//
// @exclude      *://api.stackexchange.com/*
// @exclude      *://data.stackexchange.com/*
// @exclude      *://elections.stackexchange.com/*
// @exclude      *://openid.stackexchange.com/*
// @exclude      *://blog.*.com/*
// @exclude      *://chat.*.com/*
// @exclude      *://contests.*.com/*
//
// @grant        none
// ==/UserScript==
!function(){"use strict";const e=["Profile","Профиль","Perfil","プロフィール"],t=async()=>{const t={};t.userId=document.location.pathname.match(/\/(\d+)(?:\/|$)/)?.[1];const[s]=await(e=>{const t=document.querySelectorAll(e);return t.length?Promise.resolve(t):new Promise((t=>{const s=new MutationObserver((()=>{const a=document.querySelectorAll(e);a.length&&(s.disconnect(),t(a))}));s.observe(document,{subtree:!0,childList:!0,attributes:!0})}))})("#mainbar-full");if(!s)return;const a=s.children,n=a[0]?.classList;let r=n.contains("js-cursor-container")||n.contains("system-alert")?1:0;const l=a[r+0];t.hugeUselessTopBar=l;const c=l.children,o=c[0].children,i=o[0];t.avatar=i;const d=i.cloneNode(!0);t.avatarClone=d,t.avatarCloneImage=d.querySelector("img");const m=o[1];t.userDetails=m;m.children;const u=m.firstElementChild;t.userName=u,t.header=m.querySelector(".fs-title"),t.headerExists=!!t.header,t.userLists=m.querySelectorAll("ul:not(#groups-popover > ul)"),t.userFirstList=t.userLists[0];const p=u.cloneNode(!0);t.userNameClone=p,t.userNameCloneElement=p.querySelector(".fs-headline2");const f=c[1];t.profileButtonClone=f.cloneNode(!0);const h=a[r+1];if(t.tabs=h,t.page=h.querySelector(".is-selected")?.textContent,e.includes(t.page)){const e=a[r+2];t.mainContent=e;const s=e.children[0]?.children,n=s[0].firstElementChild,l=s[1].firstElementChild;t.leftMainContent=n,[...n.children].forEach((e=>{const s=e.querySelector(".fs-title")?.textContent?.trim();switch(s){case"Stats":case"Статистика":case"Estadísticas":case"Estatística":case"統計":t.stats=e;break;case"Communities":case"Сообщества":case"Comunidades":case"コミュニティ":t.communities=e}})),t.rightMainContent=l,[...l.children].forEach((e=>{const s=e.querySelector(".fs-title")?.textContent?.trim();switch(s){case"About":case"О метке":case"Acerca de":case"Sobre":case"概要":t.prose=e;break;case"Badges":case"Знаки":case"Medallas":case"Medalhas":case"バッジ":t.badges=e;break;case"Top tags":case"Лучшие метки":case"Etiquetas principales":case"Principais tags":case"上位のタグ":t.tags=e;break;case"Newest posts":case"Top posts":case"Newest answers":case"Newest questions":case"Top answers":case"Top questions":case"Posts":case"Лучшие сообщения":case"Лучшие ответы":case"Лучшие вопросы":case"Новые сообщения":case"Новые вопросы":case"Новые ответы":case"Сообщения":case"Publicaciones principales":case"Preguntas principales":case"Respuestas principales":case"Publicaciones más nuevas":case"Preguntas más nuevas":case"Respuestas más nuevas":case"Publicaciones":case"Melhores publicações":case"Publicações recentes":case"Perguntas recentes":case"Respostas recentes":case"Principais perguntas":case"Principais respostas":case"Principais perguntas":case"Publicações":case"上位の投稿":case"上位の質問":case"上位の回答":case"新着の投稿":case"新着の質問":case"新着の回答":case"投稿":t.posts=e;break;case"Top Meta posts":t.meta=e;break;case"Top network posts":case"Лучшие сообщения сети":case"Publicaciones populares en la red":case"Melhores publicações da rede":case"ネットワークでのトップ投稿":t.network=e}}))}return t},s=t=>{const{profileButtonClone:s,stats:n,userFirstList:r}=t;let{prose:l}=t;t.avatar.querySelectorAll(".d-none").forEach((e=>e.remove())),t.avatarClone.style.marginRight="10px",t.avatarClone.querySelectorAll(".d-none").forEach((e=>e.remove())),t.avatarClone.querySelector(".gravatar-wrapper-128")?.classList?.remove("gravatar-wrapper-128");const c=t.avatarClone.querySelector("[class~='md:d-none']");c&&(c.className=""),t.avatarCloneImage.querySelectorAll(".d-none").forEach((e=>e.remove())),t.avatarCloneImage.width=t.avatarCloneImage.height=30,t.userNameCloneElement.classList.remove("mb12","fs-headline2"),t.userNameCloneElement.style.fontSize="1.61538461rem",t.userNameClone.style.marginRight="10px","Edit profile"===s.firstElementChild?.textContent.trim()&&s.firstElementChild.remove(),s.classList.remove("ps-absolute"),t.tabs.append(t.avatarClone,t.userNameClone,s);const o=s.querySelector("a");if(o&&o.classList.contains("s-btn"))o.className="s-btn s-btn__outlined s-btn__muted s-btn__icon s-btn__sm d-flex ai-center";else{const e=window.location.hostname;let t="";if(e.indexOf("meta.")>-1)t=e.replace("meta.","");else{const s=e.split("."),a=s[s.length-2];t=e.replace(a,"meta."+a)}const a=s.querySelector(`a[href*="${t}"]`)?.cloneNode(!0);a&&(a.className="s-btn s-btn__muted s-btn__icon s-btn__sm d-flex ai-center mr16",s.before(a))}if(e.includes(t.page)){if(l){l.className="flex--item fl-grow1";const e=l.children[1];t.proseText=e;const{classList:s,style:a,firstElementChild:n}=e;n.classList.add("d-grid"),s.remove("overflow-hidden","v-truncate-fade","hmx3"),s.add("overflow-y-scroll"),a.marginRight="-5px",a.paddingRight="5px",a.maxHeight=t.headerExists?"211px":"235px";const r=e.nextElementSibling;r&&r.remove();l.children[0].replaceWith(t.userName);const c={attributes:!0,attributeFilter:["style","class"]},o=e;new MutationObserver(((e,t)=>{t.disconnect(),e.forEach((e=>s.remove("overflow-hidden","v-truncate-fade","hmx3"))),t.observe(o,c)})).observe(o,c)}else t.prose=l=document.createElement("div"),l.className="flex--item fl-grow1",l.append(t.userName),t.headerExists&&t.userName.after(t.header),t.rightMainContent.firstElementChild.before(l);t.headerExists&&t.userName.after(t.header),r.style.flexDirection="column";for(let e=1;e<t.userLists.length;e++)r.append(...t.userLists[e].querySelectorAll("li:not(#groups-popover li)")),t.userLists[e].remove();[...r.children].forEach((e=>{e.querySelector(".v-visible-sr")?.remove();const t=e.textContent.trim();if(t)t.startsWith("Last seen")&&e.remove();else{const t=e.querySelector("a"),s=t.cloneNode(!0);s.textContent=t.href.toString().replace("https://",""),e.append(s)}})),r.style.whiteSpace="nowrap";const e=document.createElement("div");e.className="flex--item3",t.infoArea=e;const s=document.createElement("div");s.className="d-flex md:fd-column g16",l.replaceWith(s),s.append(l,e),(e=>{let{stats:t,badges:s}=e;const n=t.children,r=n[0],l=n[1];l.style.alignSelf="center",l.style.border="none";const c=l.firstElementChild.children,o=c[0],i=c[1],d=c[2],m=c[3];d.style.marginRight="30px",i.remove();const u=l.querySelector(".js-rank-container");u&&(u.firstElementChild?.remove(),u.firstElementChild?.classList.add("d-flex"),e.userName.append(u));const p=document.createElement("div");p.className="d-flex",p.style.marginBottom="20px",p.append(d,m),e.infoArea.append(p,e.userFirstList),o.classList.remove("flex--item"),o.classList.add("d-flex"),o.firstElementChild.style.paddingRight="5px",o.firstElementChild.style.marginTop="-2px",o.parentElement?.classList.remove("flex__allcells6");const f=e.avatar.querySelector("img");e.avatar.querySelector(".gravatar-wrapper-128")?.classList?.remove("gravatar-wrapper-128");const h=e.avatar.querySelector("[class~='md:d-none']");h&&(h.className=""),f.removeAttribute("width"),f.removeAttribute("height"),f.style.width="100%",e.avatar.style.padding="10px",r.replaceWith(e.avatar),t.classList.add("d-flex"),t.style.flexDirection="column",s&&t.append(a(s))})(t)}t.hugeUselessTopBar.remove()},a=e=>{const t=(e,t)=>{const s=document.createElement("span");s.classList.add("flex--item");const a=document.createElement("span");a.classList.add("d-flex","flex__center","fl1"),a.textContent=t;const n=document.createElement("div");switch(n.classList.add("d-flex","ai-center","s-badge"),e){case"gold":case"oro":case"ouro":case"золотых":case"золотой":n.classList.add("s-badge__gold"),n.title=t+" gold badges",s.classList.add("badge1");break;case"silver":case"plata":case"prata":case"серебряных":case"серебряный":n.classList.add("s-badge__silver"),n.title=t+" silver badges",s.classList.add("badge2");break;case"bronze":case"bronce":case"бронзовых":case"бронзовый":n.classList.add("s-badge__bronze"),n.title=t+" bronze badges",s.classList.add("badge3")}n.append(s,a);const r=document.createElement("div");return r.classList.add("flex--item"),r.append(n),r},s=document.createElement("div");let a;return s.classList.add("d-flex","gs4","flex__fl-equal"),a=e?[...e.querySelectorAll(".fs-caption")].map((e=>{const s=e.textContent.trim().replace(" badges","").replace(" badge","").replace("medallas de ","").replace("medalla de ","").replace("medalhas de ","").replace(" знаков","").replace(" знака","").replace(" знак",""),a=e.previousElementSibling?.textContent.trim();if(a)return t(s,a)})):[t("bronze",0)],s.append(...a),s.style.padding="10px",s},n=e=>{let t=e.title;return t||(t=e.firstElementChild?.title,t||"Oops.. :(")},r=(e,t,s)=>{const a=document.createElement("li");return a.textContent=t,a.style.listStyleType=`"${e} "`,a.title=s,a},l=(e,t)=>{const s=document.createElement("h3");s.textContent="Activity",s.style.color="var(--theme-primary-400)",s.style.margin="0";const a=document.createElement("ul");t?a.append(r("⇑",n(e||t),"Most recent"),r("⇓",n(t),"Very first"),r(" "," "),r("⌚",(()=>{const e=(new Date).toISOString();return e.substr(0,10)+" "+e.substr(11,8)+e.substr(23)})(),"Current time")):a.append(r(" ","❌ none")),a.style.lineHeight="1.5",a.style.marginLeft="15px";const l=document.createElement("div");return l.style.marginLeft="2px",l.style.marginTop="20px",l.style.whiteSpace="nowrap",l.append(s,a),l},c=async e=>{const{location:t}=window,s=t.pathname,a=await fetch(`${s}?tab=activity&sort=all&page=${e}`),n=await a.text();return(new DOMParser).parseFromString(n,"text/html")},o=e=>{const t=document.createElementNS("http://www.w3.org/2000/svg","svg"),s=[],a=({fill:e,d:t})=>{const s=document.createElementNS("http://www.w3.org/2000/svg","path");return e&&s.setAttribute("fill",e),t&&s.setAttribute("d",t),s};switch(e){case"eye":t.classList.add("svg-icon","iconEye"),s.push(a({d:"M9.06 3C4 3 1 9 1 9s3 6 8.06 6C14 15 17 9 17 9s-3-6-7.94-6ZM9 13a4 4 0 110-8 4 4 0 010 8Zm0-2a2 2 0 002-2 2 2 0 00-2-2 2 2 0 00-2 2 2 2 0 002 2Z"}));break;case"clock":t.classList.add("svg-icon","iconClock"),s.push(a({d:"M9 17c-4.36 0-8-3.64-8-8 0-4.36 3.64-8 8-8 4.36 0 8 3.64 8 8 0 4.36-3.64 8-8 8Zm0-2c3.27 0 6-2.73 6-6s-2.73-6-6-6-6 2.73-6 6 2.73 6 6 6ZM8 5h1.01L9 9.36l3.22 2.1-.6.93L8 10V5Z"}));break;case"network":t.classList.add("svg-icon","iconLogoSEXxs","native"),s.push(a({fill:"#8FD8F7",d:"M3 4c0-1.1.9-2 2-2h8a2 2 0 012 2H3Z"})),s.push(a({fill:"#155397",d:"M15 11H3c0 1.1.9 2 2 2h5v3l3-3a2 2 0 002-2Z"})),s.push(a({fill:"#46A2D9",d:"M3 5h12v2H3z"})),s.push(a({fill:"#2D6DB5",d:"M3 8h12v2H3z"}))}return t.append(...s),t.ariaHidden="true",t.setAttribute("width","18"),t.setAttribute("height","18"),t.setAttribute("viewBox","0 0 18 18"),t},i=async e=>{const t=(e,s=!1)=>{if(!e)return;const a=(new Date).getTime()/1e3-e+StackExchange.options.serverTimeOffsetSec;var n;return isNaN(a)||a<0?void 0:(!s&&a<2?"just now":!s&&a<60&&(1===(n={seconds:Math.floor(a)}).seconds?n.seconds+" sec ago":n.seconds+" secs ago"))||!s&&a<120&&"1 min ago"||!s&&a<3600&&function(e){return 1===e.minutes?e.minutes+" min ago":e.minutes+" mins ago"}({minutes:Math.floor(a/60)})||!s&&a<7200&&"1 hour ago"||!s&&a<43200&&function(e){return 1===e.hours?e.hours+" hour ago":e.hours+" hours ago"}({hours:Math.floor(a/3600)})||!s&&a<86400&&"today"||!s&&a<172800&&"yesterday"||!s&&a<604800&&function(e){return e.days+" days ago"}({days:Math.floor(a/86400)})||!s&&a<2592e3&&function(e){return 1===e.weeks?e.weeks+" week ago":e.weeks+" weeks ago"}({weeks:Math.floor(a/604800)})||a<31536e3&&function(e){return 0===e.months?"":1===e.months?e.months+" month ago":e.months+" months ago"}({months:Math.floor(a/2635200)})||!s&&function(s){const n=t(e+31536e3*Math.floor(a/31536e3),!0);return(1===s.years?s.years+" year":s.years+" years")+(n?", "+n:" ago")}({years:Math.floor(a/31536e3)})},s=(e,s)=>{const a=document.createElement("div");let n;var r;"view"===e?(a.textContent=`${r=s.view_count,r.toLocaleString("en-US")} profile views`,n="undefined"!=typeof Svg?Svg.Eye()?.get(0):o("eye")):(a.title=(e=>{var t=new Date;return t.setTime(1e3*e),[t.getUTCFullYear(),"-",s(t.getUTCMonth()+1),"-",s(t.getUTCDate())," ",s(t.getUTCHours()),":",s(t.getUTCMinutes()),":",s(t.getUTCSeconds()),"Z"].join("");function s(e){return e<10?"0"+e:e}})(s.last_access_date),a.textContent=`Last seen ${t(s.last_access_date)}`,n="undefined"!=typeof Svg?Svg.Clock()?.get(0):o("clock"));const l=document.createElement("div");l.className="flex--item",l.append(a);const c=document.createElement("div");c.className="flex--item fc-black-350",c.append(n);const i=document.createElement("div");i.className="d-flex gs4 gsx ai-center",i.append(c,l);const d=document.createElement("li");return d.className="flex--item",d.append(i),d},{userId:a,userFirstList:n}=e,r=await(async e=>{const t=window.location.hostname,s=await fetch(`https://api.stackexchange.com/2.2/users/${e}?filter=!40D72gVEExFusrVxd&site=${t}&key=Ql5)rGNzh1JB8xiEjeYQmQ((`);return(await s.json())?.items[0]})(a);e.networkId=r.account_id,n.append(s("view",r),s("last",r))};(async()=>{const a=await t();s(a),e.includes(a.page)&&((async({elementToAppend:e,headerPresent:t,elementToAdjust:s})=>{const a=e=>new Promise((t=>setTimeout(t,1e3*e))),n=e=>{const t=e.querySelectorAll("time");if(t)return t[t.length-1]},r=e=>{const t=e.querySelectorAll(".js-expandable-posts > .p8.py6.bb.bc-black-075");for(const e of t){const t=e.querySelector(".d-flex.fd-column.g4.ai-end.fc-black-500.wmn1 > div");if(t&&"awarded"!==t.textContent)return e.querySelector("time")}},o=(a,n)=>{e.append(l(a,n));const r=+s?.style.maxHeight.replace("px",""),c=parseInt(window.getComputedStyle(e).height);if(s){const e=Math.max(r,c-55-(t?30:0));s.style.maxHeight=e+"px"}};let i,d,m,u=1;const p=await c(u++),f=p.querySelector(".s-pagination");if(!f)return d=r(p),m=n(p),void o(d,m);{let e=f.lastElementChild;e&&"Next"===e.textContent.trim()&&(e=e.previousElementSibling),i=e.textContent.trim()}for(d=r(p);!d&&u<i;){await a(1+Math.random()+.1);const e=await c(u++);d=r(e),u===i&&(m=n(e))}u!==i&&(await a(1+Math.random()+.1),m=n(await c(i)));o(d,m)})({elementToAppend:a.infoArea,headerPresent:a.headerExists,elementToAdjust:a.proseText}),(({posts:e,badges:t})=>{e&&t&&e.after(t);const s=document.createElement("style");s.innerText="\n            #badges .fl1:nth-child(2) {\n                display: flex;\n                align-items: center;\n            }\n\n            #badges .fs-title {\n                float: left;\n                margin-right: 4px;\n            }\n\n            .spotAward {\n                transform: scale(0.75,0.75);\n            }\n            ",document.head.appendChild(s)})(a),(({tags:e})=>{if(!e)return;const t=e=>{e.classList.remove("bb","bc-black-075"),e.classList.add("flex--item"),e.querySelector("a.s-tag").style.fontSize="1.2em",e.firstElementChild.style.fontSize="1.0em",[...e.querySelectorAll(".fs-body3.mr4")].forEach((e=>e.classList.remove("fs-body3")));const t=e.querySelector(".d-flex.gsx.gs16"),s=document.createElement("div");s.style.flexDirection="column",s.className="d-flex gsx gs16";const a=t.firstElementChild.nextElementSibling,n=t.lastElementChild;a.replaceWith(s),s.append(a),s.append(n),e.querySelector(".d-flex.ai-center.gs12.fw-wrap").classList.remove("fw-wrap")},s=e=>{e.classList.remove("bb","bc-black-075"),e.classList.add("flex--item"),e.firstElementChild.style.fontSize="0.9em",[...e.querySelectorAll(".fs-body3.mr4")].forEach((e=>e.classList.remove("fs-body3"))),e.querySelector(".d-flex.gsx.gs16").style.flexDirection="column",e.querySelector(".d-flex.ai-center.gs12.fw-wrap").classList.remove("fw-wrap")},a=e.lastElementChild?.children,n=a.length,r=e.querySelector("a.s-tag");if(r){if(r.style.fontSize="1.6em",[...e.querySelectorAll(".d-flex.ai-center.gs12")].forEach((e=>e.style.backgroundColor="var(--black-025)")),n>1){const e=document.createElement("div");e.className="d-flex bb bc-black-075 flex__fl-equal";const s=a[1];s.replaceWith(e),t(s),e.append(s),a[2]&&(t(a[2]),e.append(a[2]))}if(n>3){const e=document.createElement("div");e.className="d-flex flex__fl-equal",e.style.justifyContent="space-between",e.style.alignItems="flex-end";const t=a[2];for(t.replaceWith(e),s(t),e.append(t);a[3];)s(a[3]),e.append(a[3])}[...e.querySelectorAll(".fc-light.tt-lowercase")].forEach((e=>{"Score"===e.textContent.trim()&&(e.classList.remove("fc-light"),e.style.color="var(--green-400)",e.style.fontWeight="bold")}))}})(a),(({meta:e,leftMainContent:t})=>{e&&([...e.querySelectorAll(".flex--item.px1")].forEach((e=>e.remove())),[...e.querySelectorAll("a")].forEach((e=>e.style.fontSize="100%")),t.append(e))})(a),await i(a),(({communities:e,networkId:t})=>{if(!e)return;const s=e.firstElementChild;if(!s.querySelector("a")){const e=document.createElement("a");e.href=`https://stackexchange.com/users/${t}`;const a=o("network");e.append(a),s.append(e)}const a=s.nextElementSibling?.querySelectorAll(".mod-flair");[...a].forEach((e=>{const t=e.closest("a");t.title=t.title+" ♦",e.parentElement?.previousElementSibling?.firstElementChild?.append(e)}))})(a))})()}();