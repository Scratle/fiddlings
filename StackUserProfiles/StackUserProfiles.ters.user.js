// ==UserScript==
// @name         Stack User profiles
// @description  Make use of the space like before.
// @version      2.2
//
// @namespace    scratte-fiddlings
// @author       Scratte (https://stackoverflow.com/users/12695027)
//
// @include      /^https://(?:meta\.)?askubuntu\.com/users//
// @include      /^https://(?:meta\.)?mathoverflow\.net/users//
// @include      /^https://(?:[^/]+\.)?stackoverflow\.com/users//
// @include      /^https://(?:meta\.)?superuser\.com/users//
// @include      /^https://(?:meta\.)?serverfault\.com/users//
// @include      /^https://stackapps\.com/users//
// @include      /^https://[^/]+\.stackexchange\.com/users//
// @exclude      *://api.stackexchange.com/*
// @exclude      *://data.stackexchange.com/*
// @exclude      *://elections.stackexchange.com/*
// @exclude      *://openid.stackexchange.com/*
// @exclude      *://blog.*.com/*
// @exclude      *://chat.*.com/*
// @exclude      *://contests.*.com/*
//
// @grant        none
// ==/UserScript==
!function(){"use strict";const e=["Profile","Профиль","Perfil"];function t(e){let{stats:t}=e;if(t.classList.contains("grid--item")){t=t.firstElementChild,t.className="flex--item fl-shrink0 ws2 mr24 md:mr0 md:mb24 md:w100 d-flex"}const n=t.children,s=n[0],r=n[1];r.style.alignSelf="center",r.style.border="none";const l=r.firstElementChild.children,a=l[0],i=l[1],o=l[2],c=l[3];o.style.marginRight="30px",i.remove();const d=r.querySelector(".js-rank-container");d&&(d.firstElementChild?.remove(),d.firstElementChild?.classList.add("d-flex"),e.userName.append(d));const m=document.createElement("div");m.className="d-flex",m.style.marginBottom="20px",m.append(o,c),e.rightSide.append(m,e.userFirstList),a.classList.remove("flex--item"),a.classList.add("d-flex"),a.firstElementChild.style.paddingRight="5px",a.firstElementChild.style.marginTop="-2px";const p=e.avatar.querySelector("img");p.removeAttribute("width"),p.removeAttribute("height"),p.style.width="100%",e.avatar.style.padding="10px",s.replaceWith(e.avatar),t.classList.add("d-flex"),t.style.flexDirection="column",t.append(function(){const e=document.createElement("div");e.classList.add("d-flex","gs4","flex__fl-equal");const t=document.querySelector("#badges");let n;n=t?[...t.querySelectorAll(".fs-caption")].map((e=>{const t=e.textContent.trim().replace(" badges","").replace(" badge",""),n=e.previousElementSibling?.textContent.trim();if(n)return s(t,n)})):[s("bronze",0)];return e.append(...n),e.style.padding="10px",e;function s(e,t){const n=document.createElement("span");n.classList.add("flex--item");const s=document.createElement("span");s.classList.add("d-flex","flex__center","fl1"),s.textContent=t;const r=document.createElement("div");switch(r.classList.add("d-flex","ai-center","s-badge"),e){case"gold":r.classList.add("s-badge__gold"),r.title=t+" gold badges",n.classList.add("badge1");break;case"silver":r.classList.add("s-badge__silver"),r.title=t+" silver badges",n.classList.add("badge2");break;case"bronze":r.classList.add("s-badge__bronze"),r.title=t+" bronze badges",n.classList.add("badge3")}r.append(n,s);const l=document.createElement("div");return l.classList.add("flex--item"),l.append(r),l}}())}function n(e){let t=e.title;return t||(t=e.firstElementChild?.title,t||e.querySelector(".date_brick")?.title)}function s(e,t,n){const s=document.createElement("li");return s.textContent=t,s.style.listStyleType=`"${e} "`,s.title=n,s}function r(e,t){const r=document.createElement("h3");r.textContent="Activity",r.style.color="var(--theme-primary-400)",r.style.margin="0";const l=document.createElement("ul");t?l.append(s("⇑",n(e||t),"Most recent"),s("⇓",n(t),"Very first"),s(" "," "),s("⌚",function(){const e=(new Date).toISOString();return e.substr(0,10)+" "+e.substr(11,8)+e.substr(23)}(),"Current time")):l.append(s(" ","❌ none")),l.style.lineHeight="1.5",l.style.marginLeft="15px";const a=document.createElement("div");return a.style.marginLeft="2px",a.style.marginTop="20px",a.style.whiteSpace="nowrap",a.append(r,l),a}async function l(e){const{location:t}=window,n=t.pathname,s=await fetch(`${n}?tab=activity&sort=all&page=${e}`),r=await s.text();return(new DOMParser).parseFromString(r,"text/html")}const a=function(){const t={},n=document.querySelector("#mainbar-full");if(!n)return;const s=n.children,r=s[0];t.hugeUselessTopBar=r;const l=r.children,a=l[0].children,i=a[0];t.avatar=i;const o=i.cloneNode(!0);t.avatarClone=o,t.avatarCloneImage=o.querySelector("img");const c=a[1];t.userDetails=c,c.children;const d=c.firstElementChild;t.userName=d,t.headerExists=!!c.querySelector(".fs-title"),t.userLists=c.querySelectorAll("ul:not(#groups-popover > ul)"),t.userFirstList=t.userLists[0];const m=d.cloneNode(!0);t.userNameClone=m,t.userNameCloneElement=m.querySelector(".fs-headline2");const p=l[1];t.profileButtonClone=p.cloneNode(!0);const u=s[1];if(t.tabs=u,t.page=u.querySelector(".is-selected")?.textContent,e.includes(t.page)){const e=s[2].children,n=e[0];t.topMainContent=n;const r=n.children;t.stats=r[0];const l=r[1];t.airOfMysteryContainer=l.firstElementChild?.lastElementChild?.cloneNode(!0),t.profileTextArea=l,t.prose=l.children[1];const a=e[1];t.bottomMainContent=a;const i=a.children;t.contributions=i[1]}return t}();!function(n){const{airOfMysteryContainer:s,contributions:r,profileButtonClone:l,profileTextArea:a,prose:i,stats:o,userFirstList:c}=n;if(n.avatarClone.style.marginRight="10px",n.avatar.querySelectorAll(".d-none").forEach((e=>e.remove())),n.avatarCloneImage.querySelectorAll(".d-none").forEach((e=>e.remove())),n.avatarCloneImage.width=n.avatarCloneImage.height=30,n.userNameCloneElement.classList.remove("mb12","fs-headline2"),n.userNameCloneElement.style.fontSize="1.61538461rem",n.userNameClone.style.marginRight="10px","Edit profile"===l.firstElementChild?.textContent.trim()&&l.firstElementChild.remove(),l.classList.remove("ps-absolute"),n.tabs.append(n.avatarClone,n.userNameClone,l),e.includes(n.page)){if(n.topMainContent.className="d-flex mb32 md:fd-column",a.firstElementChild.replaceWith(n.userDetails),i){const{classList:e,style:t}=i;e.remove("overflow-hidden","v-truncate-fade","hmx3"),e.add("overflow-y-scroll"),t.marginRight="-5px",t.paddingRight="5px",t.maxHeight=n.headerExists?"211px":"235px";const s=i.nextElementSibling;s&&s.remove()}else n.userDetails.append(s),s.classList.remove("flex-center"),s.style.marginRight="50px";const e=document.createElement("div");e.classList.add("d-flex","fl-grow1"),a.replaceWith(e),c.style.flexDirection="column";for(let e=1;e<n.userLists.length;e++)c.append(...n.userLists[e].querySelectorAll("li:not(#groups-popover li)")),n.userLists[e].remove();[...c.children].forEach((e=>{if(e.querySelector(".v-visible-sr")?.remove(),!e.textContent.trim()){const t=e.querySelector("a"),n=t.cloneNode(!0);n.textContent=t.href.toString().replace("https://",""),e.append(n)}})),c.style.whiteSpace="nowrap";const l=document.createElement("div");l.append(c),n.rightSide=l,a.style.marginRight="20px",a.classList.add("fl-grow1"),e.append(a,l);r?.children?.length>1?(n.bottomMainContent?.classList.remove("gs24"),r.classList.add("ml24","d-flex","fd-column"),[...r.children].forEach((e=>{e.classList.remove("mb32","mb48","mt64","pt32"),e.classList.add("mb24")}))):document.querySelector(".profile-placeholder--image")?.parentNode?.classList.remove("mt64","pt32"),t(n)}n.hugeUselessTopBar.remove()}(a),e.includes(a.page)&&async function({elementToAppend:e,headerPresent:t,elementToAdjust:n}){const s=e=>new Promise((t=>setTimeout(t,1e3*e))),a=e=>{const t=e.querySelectorAll(".date");if(t)return t[t.length-1]},i=e=>{const t=e.querySelectorAll(".history-table tr");for(const e of t){const t=e.children;if(t.length>1&&"awarded"!==t[1].textContent)return t[0]}},o=(s,l)=>{e.append(r(s,l));const a=+n.style.maxHeight.replace("px",""),i=parseInt(window.getComputedStyle(e).height);n&&(n.style.maxHeight=Math.max(a,i-92+(t?0:20))+"px")};let c,d,m,p=1;const u=await l(p++),f=u.querySelector(".s-pagination");if(!f)return d=i(u),m=a(u),void o(d,m);{let e=f.lastElementChild;e&&"Next"===e.textContent.trim()&&(e=e.previousElementSibling),c=e.textContent.trim()}for(d=i(u);!d&&p<c;){await s(1+Math.random()+.1);const e=await l(p++);d=i(e),p===c&&(m=a(e))}if(p!==c){await s(1+Math.random()+.1);m=a(await l(c))}o(d,m)}({elementToAppend:a.rightSide,headerPresent:a.headerExists,elementToAdjust:a.prose}),function(){const e=document.createElement("style");e.innerText="\n            .flex--item.fl1 #top-tags {\n                order: 1;\n            }\n            .flex--item.fl1 #top-posts {\n                order: 2;\n            }\n            .flex--item.fl1 #badges {\n                order: 3;\n            }\n\n            .profile-badges .fl1:nth-child(2) {\n                display: flex;\n                align-items: center;\n            }\n\n            .profile-badges .fs-title {\n                float: left;\n                margin-right: 4px;\n            }\n\n            .spotAward {\n                transform: scale(0.75,0.75);",document.head.appendChild(e)}()}();