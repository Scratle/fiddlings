// ==UserScript==
// @name         Stack User profiles
// @description  Make use of the space like before.
// @version      2.0
//
// @namespace    scratte-fiddlings
// @author       Scratte (https://stackoverflow.com/users/12695027)
//
// @include      /^https://(meta\.)?askubuntu\.com/users//
// @include      /^https://(meta\.)?mathoverflow\.net/users//
// @include      /^https://(meta\.)?stackoverflow\.com/users//
// @include      /^https://(meta\.)?superuser\.com/users//
// @include      /^https://(meta\.)?serverfault\.com/users//
// @include      /^https://stackapps\.com/users//
// @include      /^https://[^/]+\.stackexchange\.com/users//
// @exclude      *://api.stackexchange.com/*
// @exclude      *://data.stackexchange.com/*
// @exclude      *://elections.stackexchange.com/*
// @exclude      *://openid.stackexchange.com/*
// @exclude      *://blog.*.com/*
// @exclude      *://chat.*.com/*
// @exclude      *://contests.*.com/*
//
// @grant        none
// ==/UserScript==
!function(){"use strict";function e(e){let{stats:t}=e;if(t.classList.contains("grid--item")){t=t.firstElementChild,t.className="flex--item fl-shrink0 ws2 mr24 md:mr0 md:mb24 md:w100 d-flex"}const n=t.children,s=n[0],r=n[1];r.style.alignSelf="center",r.style.border="none";const l=r.firstElementChild.children,a=l[0],i=l[1],o=l[2],c=l[3];o.style.marginRight="30px",i.remove();const d=r.querySelector(".js-rank-container");d&&(d.firstElementChild?.remove(),d.firstElementChild?.classList.add("d-flex"),e.userName.append(d));const m=document.createElement("div");m.className="d-flex",m.style.marginBottom="20px",m.append(o,c),e.rightSide.append(m,e.userFirstList),a.classList.remove("flex--item"),a.classList.add("d-flex"),a.firstElementChild.style.paddingRight="5px",a.firstElementChild.style.marginTop="-2px";const p=e.avatar.querySelector("img");p.removeAttribute("width"),p.removeAttribute("height"),p.style.width="100%",e.avatar.style.padding="10px",s.replaceWith(e.avatar),t.classList.add("d-flex"),t.style.flexDirection="column",t.append(function(){const e=document.createElement("div");e.classList.add("d-flex","gs4","flex__fl-equal");const t=document.querySelector("#badges");let n;n=t?[...t.querySelectorAll(".fs-caption")].map((e=>{const t=e.textContent.trim().replace(" badges","").replace(" badge",""),n=e.previousElementSibling?.textContent.trim();if(n)return s(t,n)})):[s("bronze",0)];return e.append(...n),e.style.padding="10px",e;function s(e,t){const n=document.createElement("span");n.classList.add("flex--item");const s=document.createElement("span");s.classList.add("d-flex","flex__center","fl1"),s.textContent=t;const r=document.createElement("div");switch(r.classList.add("d-flex","ai-center","s-badge"),e){case"gold":r.classList.add("s-badge__gold"),r.title=t+" gold badges",n.classList.add("badge1");break;case"silver":r.classList.add("s-badge__silver"),r.title=t+" silver badges",n.classList.add("badge2");break;case"bronze":r.classList.add("s-badge__bronze"),r.title=t+" bronze badges",n.classList.add("badge3")}r.append(n,s);const l=document.createElement("div");return l.classList.add("flex--item"),l.append(r),l}}())}function t(e){let t=e.title;return t||(t=e.firstElementChild?.title,t||e.querySelector(".date_brick")?.title)}function n(e,t,n){const s=document.createElement("li");return s.textContent=t,s.style.listStyleType=`"${e} "`,s.title=n,s}function s(e,s){const r=document.createElement("h3");r.textContent="Activity",r.style.color="var(--theme-primary-400)",r.style.margin="0";const l=document.createElement("ul");s?l.append(n("⇑",t(e||s),"Most recent"),n("⇓",t(s),"Very first"),n(" "," "),n("⌚",function(){const e=(new Date).toISOString();return e.substr(0,10)+" "+e.substr(11,8)+e.substr(23)}(),"Current time")):l.append(n(" ","❌ none")),l.style.lineHeight="1.5",l.style.marginLeft="15px";const a=document.createElement("div");return a.style.marginLeft="2px",a.style.marginTop="20px",a.style.whiteSpace="nowrap",a.append(r,l),a}async function r(e){const{location:t}=window,n=t.pathname,s=await fetch(`${n}?tab=activity&sort=all&page=${e}`),r=await s.text();return(new DOMParser).parseFromString(r,"text/html")}const l=function(){const e={},t=document.querySelector("#mainbar-full");if(!t)return;const n=t.children,s=n[0];e.hugeUselessTopBar=s;const r=s.children,l=r[0].children,a=l[0];e.avatar=a;const i=a.cloneNode(!0);e.avatarClone=i,e.avatarCloneImage=i.querySelector("img");const o=l[1];e.userDetails=o,o.children;const c=o.firstElementChild;e.userName=c,e.headerExists=!!o.querySelector(".fs-title"),e.userLists=o.querySelectorAll("ul:not(#groups-popover > ul)"),e.userFirstList=e.userLists[0];const d=c.cloneNode(!0);e.userNameClone=d,e.userNameCloneElement=d.querySelector(".fs-headline2");const m=r[1];e.profileButtonClone=m.cloneNode(!0);const p=n[1];if(e.tabs=p,e.page=p.querySelector(".is-selected")?.textContent,"Profile"===e.page){const t=n[2].children,s=t[0];e.topMainContent=s;const r=s.children;e.stats=r[0];const l=r[1];e.airOfMysteryContainer=l.firstElementChild?.lastElementChild?.cloneNode(!0),e.profileTextArea=l,e.prose=l.children[1];const a=t[1];e.bottomMainContent=a;const i=a.children;e.contributions=i[1]}return e}();!function(t){const{airOfMysteryContainer:n,contributions:s,profileButtonClone:r,profileTextArea:l,prose:a,stats:i,userFirstList:o}=t;if(t.avatarClone.style.marginRight="10px",t.avatar.querySelectorAll(".d-none").forEach((e=>e.remove())),t.avatarCloneImage.querySelectorAll(".d-none").forEach((e=>e.remove())),t.avatarCloneImage.width=t.avatarCloneImage.height=30,t.userNameCloneElement.classList.remove("mb12","fs-headline2"),t.userNameCloneElement.style.fontSize="1.61538461rem",t.userNameClone.style.marginRight="10px","Edit profile"===r.firstElementChild?.textContent.trim()&&r.firstElementChild.remove(),r.classList.remove("ps-absolute"),t.tabs.append(t.avatarClone,t.userNameClone,r),"Profile"===t.page){if(t.topMainContent.className="d-flex mb32 md:fd-column",l.firstElementChild.replaceWith(t.userDetails),a){const{classList:e,style:n}=a;e.remove("overflow-hidden","v-truncate-fade","hmx3"),e.add("overflow-y-scroll"),n.marginRight="-5px",n.paddingRight="5px",n.maxHeight=t.headerExists?"211px":"235px";const s=a.nextElementSibling;s&&s.remove()}else t.userDetails.append(n),n.classList.remove("flex-center"),n.style.marginRight="50px";const r=document.createElement("div");r.classList.add("d-flex","fl-grow1"),l.replaceWith(r),o.style.flexDirection="column";for(let e=1;e<t.userLists.length;e++)o.append(...t.userLists[e].querySelectorAll("li:not(#groups-popover li)")),t.userLists[e].remove();[...o.children].forEach((e=>{if(!e.textContent.trim()){const t=e.querySelector("a"),n=t.cloneNode(!0);n.textContent=t.href.toString().replace("https://",""),e.append(n)}})),o.style.whiteSpace="nowrap";const i=document.createElement("div");i.append(o),t.rightSide=i,l.style.marginRight="20px",l.classList.add("fl-grow1"),r.append(l,i);s?.children?.length>1?(t.bottomMainContent?.classList.remove("gs24"),s.classList.add("ml24","d-flex","fd-column"),[...s.children].forEach((e=>{e.classList.remove("mb32","mb48","mt64","pt32"),e.classList.add("mb24")}))):document.querySelector(".profile-placeholder--image")?.parentNode?.classList.remove("mt64","pt32"),e(t)}t.hugeUselessTopBar.remove()}(l),async function({elementToAppend:e,headerPresent:t,elementToAdjust:n}){const l=e=>new Promise((t=>setTimeout(t,1e3*e))),a=e=>{const t=e.querySelectorAll(".date");if(t)return t[t.length-1]},i=e=>{const t=e.querySelectorAll(".history-table tr");for(const e of t){const t=e.children;if(t.length>1&&"awarded"!==t[1].textContent)return t[0]}},o=(r,l)=>{e.append(s(r,l));const a=+n.style.maxHeight.replace("px",""),i=parseInt(window.getComputedStyle(e).height);n&&(n.style.maxHeight=Math.max(a,i-92+(t?0:20))+"px")};let c,d,m,p=1;const u=await r(p++),f=u.querySelector(".s-pagination");if(!f)return d=i(u),m=a(u),void o(d,m);{let e=f.lastElementChild;e&&"Next"===e.textContent.trim()&&(e=e.previousElementSibling),c=e.textContent.trim()}for(d=i(u);!d&&p<c;){await l(1+Math.random()+.1);const e=await r(p++);d=i(e),p===c&&(m=a(e))}if(p!==c){await l(1+Math.random()+.1);m=a(await r(c))}o(d,m)}({elementToAppend:l.rightSide,headerPresent:l.headerExists,elementToAdjust:l.prose}),function(){const e=document.createElement("style");e.innerText="\n            .flex--item.fl1 #top-tags {\n                order: 1;\n            }\n            .flex--item.fl1 #top-posts {\n                order: 2;\n            }\n            .flex--item.fl1 #badges {\n                order: 3;\n            }\n\n            .profile-badges .fl1:nth-child(2) {\n                display: flex;\n                align-items: center;\n            }\n\n            .profile-badges .fs-title {\n                float: left;\n                margin-right: 4px;\n            }\n\n            .spotAward {\n                transform: scale(0.75,0.75);",document.head.appendChild(e)}()}();