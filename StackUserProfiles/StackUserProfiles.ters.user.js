// ==UserScript==
// @name         Stack User Profiles
// @description  Make use of the space like before.
// @version      2.9
//
// @namespace    scratte-fiddlings
// @author       Scratte (https://stackoverflow.com/users/12695027)
//
// @include      /^https://(?:meta\.)?askubuntu\.com/users//
// @include      /^https://(?:meta\.)?mathoverflow\.net/users//
// @include      /^https://(?:[^/]+\.)?stackoverflow\.com/users//
// @include      /^https://(?:meta\.)?superuser\.com/users//
// @include      /^https://(?:meta\.)?serverfault\.com/users//
// @include      /^https://stackapps\.com/users//
// @include      /^https://[^/]+\.stackexchange\.com/users//
// @exclude      *://api.stackexchange.com/*
// @exclude      *://data.stackexchange.com/*
// @exclude      *://elections.stackexchange.com/*
// @exclude      *://openid.stackexchange.com/*
// @exclude      *://blog.*.com/*
// @exclude      *://chat.*.com/*
// @exclude      *://contests.*.com/*
//
// @grant        none
// ==/UserScript==
!function(){"use strict";const e=["Profile","Профиль","Perfil","プロフィール"],t=async()=>{const t={};t.userId=document.location.pathname.match(/\/(\d+)(?:\/|$)/)?.[1];const[a]=await(e=>{const t=document.querySelectorAll(e);return t.length?Promise.resolve(t):new Promise((t=>{const a=new MutationObserver((()=>{const n=document.querySelectorAll(e);n.length&&(a.disconnect(),t(n))}));a.observe(document,{subtree:!0,childList:!0,attributes:!0})}))})("#mainbar-full");if(!a)return;const n=a.children,s=n[0]?.classList;let r=s.contains("js-cursor-container")||s.contains("system-alert")?1:0;const o=n[r+0];t.hugeUselessTopBar=o;const l=o.children,i=l[0].children,c=i[0];t.avatar=c;const d=c.cloneNode(!0);t.avatarClone=d,t.avatarCloneImage=d.querySelector("img");const m=i[1];t.userDetails=m;m.children;const p=m.firstElementChild;t.userName=p,t.headerExists=!!m.querySelector(".fs-title"),t.userLists=m.querySelectorAll("ul:not(#groups-popover > ul)"),t.userFirstList=t.userLists[0];const u=p.cloneNode(!0);t.userNameClone=u,t.userNameCloneElement=u.querySelector(".fs-headline2");const g=l[1];t.profileButtonClone=g.cloneNode(!0);const h=n[r+1];if(t.tabs=h,t.page=h.querySelector(".is-selected")?.textContent,e.includes(t.page)){const e=n[r+2].children,a=e[0];t.topMainContent=a;const s=a.children;t.stats=s[0];const o=s[1];t.airOfMysteryContainer=o.firstElementChild?.lastElementChild?.cloneNode(!0),t.profileTextArea=o,t.prose=o.children[1];const l=e[1];t.bottomMainContent=l;const i=l.children;t.contributions=i[1]}return t},a=t=>{const{airOfMysteryContainer:a,contributions:s,profileButtonClone:r,profileTextArea:o,prose:l,stats:i,userFirstList:c}=t;t.avatar.querySelectorAll(".d-none").forEach((e=>e.remove())),t.avatarClone.style.marginRight="10px",t.avatarClone.querySelectorAll(".d-none").forEach((e=>e.remove())),t.avatarClone.querySelector(".gravatar-wrapper-128")?.classList?.remove("gravatar-wrapper-128");const d=t.avatarClone.querySelector("[class~='md:d-none']");if(d&&(d.className=""),t.avatarCloneImage.querySelectorAll(".d-none").forEach((e=>e.remove())),t.avatarCloneImage.width=t.avatarCloneImage.height=30,t.userNameCloneElement.classList.remove("mb12","fs-headline2"),t.userNameCloneElement.style.fontSize="1.61538461rem",t.userNameClone.style.marginRight="10px","Edit profile"===r.firstElementChild?.textContent.trim()&&r.firstElementChild.remove(),r.classList.remove("ps-absolute"),t.tabs.append(t.avatarClone,t.userNameClone,r),e.includes(t.page)){if(t.topMainContent.className="d-flex mb32 md:fd-column",o.firstElementChild.replaceWith(t.userDetails),l){const{classList:e,style:a}=l;setTimeout((()=>e.remove("overflow-hidden","v-truncate-fade","hmx3")),100),e.add("overflow-y-scroll"),a.marginRight="-5px",a.paddingRight="5px",a.maxHeight=t.headerExists?"211px":"235px";const n=l.nextElementSibling;n&&n.remove()}else t.userDetails.append(a),a.classList.remove("flex-center"),a.style.marginRight="50px";const e=document.createElement("div");e.classList.add("d-flex","fl-grow1"),o.replaceWith(e),c.style.flexDirection="column";for(let e=1;e<t.userLists.length;e++)c.append(...t.userLists[e].querySelectorAll("li:not(#groups-popover li)")),t.userLists[e].remove();[...c.children].forEach((e=>{if(e.querySelector(".v-visible-sr")?.remove(),!e.textContent.trim()){const t=e.querySelector("a"),a=t.cloneNode(!0);a.textContent=t.href.toString().replace("https://",""),e.append(a)}})),c.style.whiteSpace="nowrap";const r=document.createElement("div");r.append(c),t.rightSide=r,o.style.marginRight="20px",o.classList.add("fl-grow1"),e.append(o,r);s?.children?.length>1?(t.bottomMainContent?.classList.remove("gs24"),s.classList.add("ml24","d-flex","fd-column"),[...s.children].forEach((e=>{e.classList.remove("mb32","mb48","mt64","pt32"),e.classList.add("mb24")}))):document.querySelector(".profile-placeholder--image")?.parentNode?.classList.remove("mt64","pt32"),(e=>{let{stats:t}=e;t.classList.contains("grid--item")&&(t=t.firstElementChild,t.className="flex--item fl-shrink0 ws2 mr24 md:mr0 md:mb24 md:w100 d-flex");const a=t.children,s=a[0],r=a[1];r.style.alignSelf="center",r.style.border="none";const o=r.firstElementChild.children,l=o[0],i=o[1],c=o[2],d=o[3];c.style.marginRight="30px",i.remove();const m=r.querySelector(".js-rank-container");m&&(m.firstElementChild?.remove(),m.firstElementChild?.classList.add("d-flex"),e.userName.append(m));const p=document.createElement("div");p.className="d-flex",p.style.marginBottom="20px",p.append(c,d),e.rightSide.append(p,e.userFirstList),l.classList.remove("flex--item"),l.classList.add("d-flex"),l.firstElementChild.style.paddingRight="5px",l.firstElementChild.style.marginTop="-2px",l.parentElement?.classList.remove("flex__allcells6");const u=e.avatar.querySelector("img");e.avatar.querySelector(".gravatar-wrapper-128")?.classList?.remove("gravatar-wrapper-128");const g=e.avatar.querySelector("[class~='md:d-none']");g&&(g.className=""),u.removeAttribute("width"),u.removeAttribute("height"),u.style.width="100%",e.avatar.style.padding="10px",s.replaceWith(e.avatar),t.classList.add("d-flex"),t.style.flexDirection="column",t.append(n())})(t)}t.hugeUselessTopBar.remove()},n=()=>{const e=(e,t)=>{const a=document.createElement("span");a.classList.add("flex--item");const n=document.createElement("span");n.classList.add("d-flex","flex__center","fl1"),n.textContent=t;const s=document.createElement("div");switch(s.classList.add("d-flex","ai-center","s-badge"),e){case"gold":case"oro":case"ouro":case"золотых":case"золотой":s.classList.add("s-badge__gold"),s.title=t+" gold badges",a.classList.add("badge1");break;case"silver":case"plata":case"prata":case"серебряных":case"серебряный":s.classList.add("s-badge__silver"),s.title=t+" silver badges",a.classList.add("badge2");break;case"bronze":case"bronce":case"бронзовых":case"бронзовый":s.classList.add("s-badge__bronze"),s.title=t+" bronze badges",a.classList.add("badge3")}s.append(a,n);const r=document.createElement("div");return r.classList.add("flex--item"),r.append(s),r},t=document.createElement("div");t.classList.add("d-flex","gs4","flex__fl-equal");const a=document.querySelector("#badges");let n;return n=a?[...a.querySelectorAll(".fs-caption")].map((t=>{const a=t.textContent.trim().replace(" badges","").replace(" badge","").replace("medallas de ","").replace("medalla de ","").replace("medalhas de ","").replace(" знаков","").replace(" знака","").replace(" знак",""),n=t.previousElementSibling?.textContent.trim();if(n)return e(a,n)})):[e("bronze",0)],t.append(...n),t.style.padding="10px",t},s=e=>{let t=e.title;return t||(t=e.firstElementChild?.title,t||e.querySelector(".date_brick")?.title)},r=(e,t,a)=>{const n=document.createElement("li");return n.textContent=t,n.style.listStyleType=`"${e} "`,n.title=a,n},o=(e,t)=>{const a=document.createElement("h3");a.textContent="Activity",a.style.color="var(--theme-primary-400)",a.style.margin="0";const n=document.createElement("ul");t?n.append(r("⇑",s(e||t),"Most recent"),r("⇓",s(t),"Very first"),r(" "," "),r("⌚",(()=>{const e=(new Date).toISOString();return e.substr(0,10)+" "+e.substr(11,8)+e.substr(23)})(),"Current time")):n.append(r(" ","❌ none")),n.style.lineHeight="1.5",n.style.marginLeft="15px";const o=document.createElement("div");return o.style.marginLeft="2px",o.style.marginTop="20px",o.style.whiteSpace="nowrap",o.append(a,n),o},l=async e=>{const{location:t}=window,a=t.pathname,n=await fetch(`${a}?tab=activity&sort=all&page=${e}`),s=await n.text();return(new DOMParser).parseFromString(s,"text/html")},i=e=>{const t=document.createElementNS("http://www.w3.org/2000/svg","svg"),a=document.createElementNS("http://www.w3.org/2000/svg","path");switch(e){case"eye":t.classList.add("svg-icon","iconEye"),a.setAttribute("d","M9.06 3C4 3 1 9 1 9s3 6 8.06 6C14 15 17 9 17 9s-3-6-7.94-6ZM9 13a4 4 0 110-8 4 4 0 010 8Zm0-2a2 2 0 002-2 2 2 0 00-2-2 2 2 0 00-2 2 2 2 0 002 2Z");break;case"clock":t.classList.add("svg-icon","iconClock"),a.setAttribute("d","M9 17c-4.36 0-8-3.64-8-8 0-4.36 3.64-8 8-8 4.36 0 8 3.64 8 8 0 4.36-3.64 8-8 8Zm0-2c3.27 0 6-2.73 6-6s-2.73-6-6-6-6 2.73-6 6 2.73 6 6 6ZM8 5h1.01L9 9.36l3.22 2.1-.6.93L8 10V5Z")}return t.append(a),t.ariaHidden="true",t.setAttribute("width","18"),t.setAttribute("height","18"),t.setAttribute("viewBox","0 0 18 18"),t},c=async({userId:e,userFirstList:t})=>{const a=(e,t=!1)=>{if(!e)return;const n=(new Date).getTime()/1e3-e+StackExchange.options.serverTimeOffsetSec;var s;return isNaN(n)||n<0?void 0:(!t&&n<2?"just now":!t&&n<60&&(1===(s={seconds:Math.floor(n)}).seconds?s.seconds+" sec ago":s.seconds+" secs ago"))||!t&&n<120&&"1 min ago"||!t&&n<3600&&function(e){return 1===e.minutes?e.minutes+" min ago":e.minutes+" mins ago"}({minutes:Math.floor(n/60)})||!t&&n<7200&&"1 hour ago"||!t&&n<43200&&function(e){return 1===e.hours?e.hours+" hour ago":e.hours+" hours ago"}({hours:Math.floor(n/3600)})||!t&&n<86400&&"today"||!t&&n<172800&&"yesterday"||!t&&n<604800&&function(e){return e.days+" days ago"}({days:Math.floor(n/86400)})||!t&&n<2592e3&&function(e){return 1===e.weeks?e.weeks+" week ago":e.weeks+" weeks ago"}({weeks:Math.floor(n/604800)})||n<31536e3&&function(e){return 0===e.months?"":1===e.months?e.months+" month ago":e.months+" months ago"}({months:Math.floor(n/2635200)})||!t&&function(t){const s=a(e+31536e3*Math.floor(n/31536e3),!0);return(1===t.years?t.years+" year":t.years+" years")+(s?", "+s:" ago")}({years:Math.floor(n/31536e3)})},n=(e,t)=>{const n=document.createElement("div");let s;var r;"view"===e?(n.textContent=`${r=t.view_count,r.toLocaleString("en-US")} profile views`,s="undefined"!=typeof Svg?Svg.Eye()?.get(0):i("eye")):(n.title=(e=>{var t=new Date;return t.setTime(1e3*e),[t.getUTCFullYear(),"-",a(t.getUTCMonth()+1),"-",a(t.getUTCDate())," ",a(t.getUTCHours()),":",a(t.getUTCMinutes()),":",a(t.getUTCSeconds()),"Z"].join("");function a(e){return e<10?"0"+e:e}})(t.last_access_date),n.textContent=`Last seen ${a(t.last_access_date)}`,s="undefined"!=typeof Svg?Svg.Clock()?.get(0):i("clock"));const o=document.createElement("div");o.className="flex--item",o.append(n);const l=document.createElement("div");l.className="flex--item fc-black-350",l.append(s);const c=document.createElement("div");c.className="d-flex gs4 gsx ai-center",c.append(l,o);const d=document.createElement("li");return d.className="flex--item",d.append(c),d},s=await(async e=>{const t=window.location.hostname,a=await fetch(`https://api.stackexchange.com/2.2/users/${e}?filter=!bWWrYUhX0a2k7x&site=${t}&key=Ql5)rGNzh1JB8xiEjeYQmQ((`);return(await a.json())?.items[0]})(e);t.append(n("view",s),n("last",s))};(async()=>{const n=await t();a(n),e.includes(n.page)&&(async({elementToAppend:e,headerPresent:t,elementToAdjust:a})=>{const n=e=>new Promise((t=>setTimeout(t,1e3*e))),s=e=>{const t=e.querySelectorAll(".date");if(t)return t[t.length-1]},r=e=>{const t=e.querySelectorAll(".history-table tr");for(const e of t){const t=e.children;if(t.length>1&&"awarded"!==t[1].textContent)return t[0]}},i=(n,s)=>{e.append(o(n,s));const r=+a?.style.maxHeight.replace("px",""),l=parseInt(window.getComputedStyle(e).height);a&&(a.style.maxHeight=Math.max(r,l-92+(t?0:20))+"px")};let c,d,m,p=1;const u=await l(p++),g=u.querySelector(".s-pagination");if(!g)return d=r(u),m=s(u),void i(d,m);{let e=g.lastElementChild;e&&"Next"===e.textContent.trim()&&(e=e.previousElementSibling),c=e.textContent.trim()}for(d=r(u);!d&&p<c;){await n(1+Math.random()+.1);const e=await l(p++);d=r(e),p===c&&(m=s(e))}p!==c&&(await n(1+Math.random()+.1),m=s(await l(c)));i(d,m)})({elementToAppend:n.rightSide,headerPresent:n.headerExists,elementToAdjust:n.prose}),(()=>{const e=document.createElement("style");e.innerText="\n            .flex--item.fl1 #top-tags {\n                order: 1;\n            }\n            .flex--item.fl1 #top-posts {\n                order: 2;\n            }\n            .flex--item.fl1 #badges {\n                order: 3;\n            }\n\n            .profile-badges .fl1:nth-child(2) {\n                display: flex;\n                align-items: center;\n            }\n\n            .profile-badges .fs-title {\n                float: left;\n                margin-right: 4px;\n            }\n\n            .spotAward {\n                transform: scale(0.75,0.75);\n            }\n\n            /* make the background transparent on the tag badge medal */\n            .badge1-alternate.badge-tag,\n            .badge2-alternate.badge-tag,\n            .badge3-alternate.badge-tag {\n                background-color: transparent !important;\n            }\n\n            /* center the tag badge medal */\n            .profile-top-tags > div:first-child .badge1-alternate.badge-tag > span,\n            .profile-top-tags > div:first-child .badge2-alternate.badge-tag > span,\n            .profile-top-tags > div:first-child .badge3-alternate.badge-tag > span {\n                vertical-align: initial !important;\n            }\n            ",document.head.appendChild(e)})(),e.includes(n.page)&&c(n)})()}();